# コンパス表示と極軸合わせ表示の実装ノウハウ

## 方位角計算の統一

- コンパス表示（showCompass）と極軸合わせ表示（showPolarAlignment）では、同じ方位角計算方法を使用する
- 北が上になるように調整するには、両方のメソッドで `float angle = -heading * PI / 180.0;` を使用する
- マイナス符号は時計回りの回転を表現するために必要（画面上の角度と方位角の向きの違いを調整）

## 北極星の表示方法

- 北極星は常に北（0度）に位置するため、画面上では上部に固定表示する
- 固定位置の計算方法：
  ```cpp
  int px = centerX;
  int py = centerY - (radius * 0.7);
  ```
- 北極星の位置を実際の方位角に基づいて動的に計算すると、誤った表示になる可能性がある
- 北極星マークは青い十字（シアン色）で表示し、目標位置を明確に示す

## 極軸合わせの視覚的表現

- 赤い線：デバイスの現在の向き（方位）を示す
- 水色の北極星マーク：天の北極（北極星）の方向を示す
- 極軸合わせの目標：赤い線（デバイスの向き）を水色の北極星マーク（天の北極）に合わせること
- この表示方法により、ユーザーは直感的に極軸合わせを行うことができる

## 仰角インジケーターの実装

- 垂直バーで仰角（高度）を表示：-90度（下端）から+90度（上端）の範囲
- 白い水平線：0度（水平）を示す
- 水色のマーカー：北極星の高度（観測地点の緯度に近い値）を示す
- 黄色の三角マーカー：デバイスの現在のピッチ角を示す
- 極軸合わせの目標：黄色の三角マーカー（現在のピッチ）を水色のマーカー（北極星の高度）に合わせること
- 計算方法：
  ```cpp
  // 角度を0〜1の範囲に正規化
  float normalizedAlt = (polarisAlt + 90.0) / 180.0; // -90度→0.0、0度→0.5、+90度→1.0
  // 画面座標に変換（上が小さい値、下が大きい値なので反転）
  int targetPosY = barY + barHeight - (int)(normalizedAlt * barHeight);
  ```

## 一般的な問題と解決策

- 方位角が正しく表示されない場合：方位角計算の符号（-heading vs heading）を確認
- 北極星が動いてしまう場合：北極星の位置を固定値で設定（動的計算を避ける）
- コンパスが回転しない場合：IMUFusionクラスでの方位角計算を確認
- 仰角ターゲットが正しく表示されない場合：polarisAltの計算と座標変換の計算式を確認

## 改善案

### 視覚的表示の強化
- 現在のコンパスローズと水平線表示を統合し、3D的な表現に改善
- 極軸合わせの円表示をより直感的に（現在位置と目標位置の関係をより明確に）
- カラーグラデーションを使用して精度を視覚的に表現

### 情報表示の最適化
- 重要な情報（方位角誤差、ピッチ/ロール）を目立たせる
- 情報の階層化（最重要情報を大きく、詳細情報を小さく）
- 数値とグラフィック表示の連携強化
