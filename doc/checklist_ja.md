# Polaris Navigator ビルド前チェックリスト

## 概要

このチェックリストは、Polaris Navigatorのビルド前に確認すべき項目をまとめたものです。これらの項目を確認することで、一般的なビルドエラーを事前に防ぐことができます。

## コード構造のチェック

### ヘッダファイル (.h)

- [ ] クラス宣言に必要なすべてのメンバー関数が含まれているか
- [ ] 関数宣言の引数の型と数が実装と一致しているか
- [ ] 必要なヘッダファイルがすべてインクルードされているか
- [ ] クラスの継承関係が正しく定義されているか
- [ ] 名前空間が適切に使用されているか

### 実装ファイル (.cpp)

- [ ] すべての宣言された関数に対応する実装があるか
- [ ] 関数の実装が宣言と一致しているか（引数の型、数、戻り値の型）
- [ ] クラスメソッドが `ClassName::methodName` の形式で定義されているか
- [ ] 同じ関数が複数回定義されていないか
- [ ] 必要なヘッダファイルがすべてインクルードされているか

### メインスケッチ (.ino)

- [ ] `setup()` と `loop()` 関数が正しく実装されているか
- [ ] 必要なライブラリがすべてインクルードされているか
- [ ] グローバル変数が適切に初期化されているか
- [ ] 関数呼び出しの引数が正しいか（型、数）

## IMUとコンパスのチェック項目

### 座標系と軸の対応関係

- [ ] AtomS3Rの物理的な座標系（X, Y, Z軸）の定義が明確になっているか
- [ ] 加速度センサー（BMI270）の軸がAtomS3Rの座標系と正しく対応しているか
- [ ] 地磁気センサー（BMM150）の軸がAtomS3Rの座標系と正しく対応しているか
- [ ] 軸の符号（正負）が正しく設定されているか
- [ ] 複数の場所で軸の調整を行っている場合、すべての場所で一貫した方法を使用しているか

### 方位角計算

- [ ] 方位角計算の数式（atan2関数の引数の順序）が正しいか
- [ ] 方位角の単位変換（ラジアンから度、度からラジアン）が正しく行われているか
- [ ] 方位角の範囲調整（0〜360度）が適切に行われているか
- [ ] 傾き補正（ピッチとロールを考慮した方位角計算）が正しく実装されているか
- [ ] メインスケッチとIMUFusionクラスで同じ方位角計算方法が使用されているか

### 描画と表示

- [ ] コンパスの針（赤線）の角度計算が方位角計算と一致しているか
- [ ] 画面上での角度の向き（時計回り/反時計回り、0度の位置）が正しく設定されているか
- [ ] 北極星などの固定マーカーが適切な位置に表示されるよう設定されているか
- [ ] 条件付き表示ロジック（if文による表示制御）が意図通りに機能するか
- [ ] 異なる表示モード間で角度計算方法が一貫しているか

## 一般的なエラーのチェック

### 未定義シンボル

- [ ] 使用しているすべての変数、定数、関数が定義またはインクルードされているか
- [ ] 定数名が正しいか（例：`TFT_GRAY` ではなく `TFT_DARKGREY` を使用）
- [ ] 名前空間の指定が必要な場合、正しく指定されているか

### 型の不一致

- [ ] 関数の引数の型が宣言と一致しているか
- [ ] 変数の型が適切か（特に数値型の場合、int, float, doubleなど）
- [ ] キャストが必要な場合、適切にキャストされているか

### メモリ関連

- [ ] 大きな配列やバッファが適切なサイズで宣言されているか
- [ ] ヒープメモリの割り当てと解放が適切に行われているか
- [ ] スタックオーバーフローの可能性がある大きな局所変数がないか

## 特定機能のチェック

### IMUセンサー

- [ ] センサーの初期化コードが正しいか
- [ ] キャリブレーション処理が実装されているか
- [ ] センサーデータの読み取りと変換が正しく行われているか
- [ ] エラー処理が実装されているか

### GPS

- [ ] GPS_TX_PIN (5) と GPS_RX_PIN (-1) の設定が正しいか
- [ ] GPSデータの解析処理が正しく実装されているか
- [ ] 無効なGPSデータに対するエラー処理があるか
- [ ] GPSが見えない場合の時刻処理が適切に実装されているか
  - [ ] `timeValid` フラグが適切に設定・確認されているか
  - [ ] 太陽と月の位置計算が `timeValid` フラグに基づいて条件分岐されているか
  - [ ] 極軸位置計算がGPS位置情報のみで実行されるよう実装されているか

### ディスプレイ

- [ ] スプライトの初期化と解放が適切に行われているか
- [ ] `_sprite` がnullの場合の分岐処理が実装されているか
- [ ] 色定数が正しく使用されているか（TFT_で始まる定数）
- [ ] テキストサイズ、色、位置の設定が適切か

### 天体情報表示

- [ ] `showCelestialData`メソッドが正しく実装されているか
- [ ] 太陽と月の位置が正しく計算されているか
- [ ] 月齢の計算と表示が適切に行われているか
- [ ] コンパスローズ上の天体位置表示が視覚的に分かりやすいか

## ビルド環境のチェック

- [ ] Arduino IDEのバージョンが最新か
- [ ] 必要なすべてのライブラリがインストールされているか
- [ ] ボード設定が正しいか（m5stack:esp32:m5stack_atoms3r）
- [ ] コンパイルオプションが適切か

## 最終チェック

- [ ] すべてのファイルが保存されているか
- [ ] 一時的なデバッグコードやコメントアウトが残っていないか
- [ ] コードのフォーマットが一貫しているか
- [ ] 不要なコードや使われていない変数がないか

## ビルド後のチェック

- [ ] コンパイルエラーがないか
- [ ] 警告メッセージがないか
- [ ] ビルドサイズが適切か（フラッシュメモリとRAMの使用量）
- [ ] アップロード後に期待通りに動作するか

## トラブルシューティング

ビルドエラーが発生した場合は、以下の手順で対処してください：

1. エラーメッセージを注意深く読み、問題のあるファイルと行番号を特定
2. 該当する箇所のコードを確認し、上記のチェックリストに基づいて問題を特定
3. 一度に複数の変更を行った場合は、変更を一つずつ元に戻して問題の原因を特定
4. 解決できない場合は、`knowhow_ja.md` を参照するか、エラーメッセージを検索して解決策を探す

このチェックリストを定期的に更新し、新たに発見された問題や解決策を追加してください。
