# Polaris Navigator ビルドノウハウ

## 概要

このドキュメントはPolaris Navigatorのビルドプロセスに関するノウハウと一般的な問題解決方法をまとめています。

## ビルド環境

- **Arduino IDE**: 最新版を使用
- **ボード**: M5Stack AtomS3R
- **ボード設定**: m5stack:esp32:m5stack_atoms3r
- **Arduino CLI**: C:\Program Files\Arduino IDE\resources\app\lib\backend\resources\arduino-cli.exe

## ビルドコマンド

```bash
& "C:\Program Files\Arduino IDE\resources\app\lib\backend\resources\arduino-cli.exe" compile --fqbn m5stack:esp32:m5stack_atoms3r .
```

## 一般的なビルドエラーと解決方法

### 1. 関数宣言と定義の不一致

**エラー例**:
```bash
function expects X arguments, Y provided
```

**解決方法**:
- ヘッダファイル(.h)での関数宣言と、実装ファイル(.cpp)での関数定義の引数が一致しているか確認
- 呼び出し側のコードが正しい数の引数を渡しているか確認

### 2. 未定義のシンボル

**エラー例**:
```
'SYMBOL_NAME' was not declared in this scope
```

**解決方法**:
- 必要なヘッダファイルがインクルードされているか確認
- 定数名が正しいか確認（例：TFT_GRAYではなくTFT_DARKGREYを使用）
- 名前空間の指定が必要な場合は追加

### 3. 関数の重複定義

**エラー例**:
```
'function_name' previously defined here
```

**解決方法**:
- 同じ関数が複数の場所で定義されていないか確認
- クラスメソッドの場合、クラス名::メソッド名の形式で定義されているか確認

### 4. メンバー関数の未定義

**エラー例**:
```
'CLASS_NAME' has no member named 'FUNCTION_NAME'
```

**解決方法**:
- クラスのヘッダファイルに関数が宣言されているか確認
- 関数名のスペルミスがないか確認
- 継承関係を確認（親クラスのメソッドを呼び出している場合）

### 5. ライブラリの問題

**エラー例**:
```
No such file or directory
```

**解決方法**:
- 必要なライブラリがインストールされているか確認
- ライブラリのバージョンが互換性があるか確認
- インクルードパスが正しいか確認

### 6. C++のメソッド実装順序の問題

**エラー例**:
```
'methodName's scope
```

**解決方法**:
- C++では、メソッドの実装順序が重要です。あるメソッドが別のメソッドを呼び出す場合、呼び出されるメソッドを先に実装する必要があります。
- 循環参照がある場合は、前方宣言を使用するか、実装を分割する必要があります。
- クラスのメソッドをprivateからpublicに変更することで解決できる場合もあります。

### 7. M5Stackハードウェア固有の問題

**エラー例**:
```
'm5::M5Unified' has no member named 'dis'
```

**解決方法**:
- AtomS3Rなど特定のM5Stackデバイスでは、LEDやディスプレイの制御方法が異なります。
- AtomS3RではLEDの制御に`M5.dis`ではなく`M5.Lcd.fillScreen()`を使用します。
- ハードウェア固有の機能を使用する場合は、デバイスのドキュメントを確認してください。

### 8. 未実装メソッドの問題

**エラー例**:
```
undefined reference to 'ClassName::methodName'
```

**解決方法**:
- ヘッダファイル(.h)で宣言されているメソッドが実装ファイル(.cpp)で実装されていない場合に発生します。
- すべての宣言されたメソッドが実装されているか確認してください。
- 使用していないメソッドは宣言から削除するか、空の実装を提供してください。

### 9. ライブラリマクロとの名前競合

**エラー例**:
```
expected unqualified-id before numeric constant
```

**解決方法**:
- ESP32のlwIPライブラリなど、システムライブラリで定義されているマクロ名と競合していないか確認
- 特に `RAW_DEBUG` のような一般的な名前は、ライブラリですでに定義されている可能性がある
- 競合する場合は、プロジェクト固有のプレフィックスを付けるか（例：`PN_DEBUG`）、別の名前に変更する（例：`DISPLAY_DEBUG`）

### 10. 重複したケース値

**エラー例**:
```
duplicate case value
```

**解決方法**:
- switchステートメント内で同じ値を持つcaseが複数定義されていないか確認
- 列挙型で同じ値を持つ複数の定数を定義している場合、switchステートメントでは一つだけ使用する
- エイリアスとして同じ値を持つ列挙型を定義する場合は、コメントで明示する

## デバッグのヒント

1. **シリアルモニタの活用**: 
   - 重要な変数の値や処理の流れをシリアル出力で確認
   - `Serial.print()` や `Serial.println()` を戦略的に配置

2. **段階的なビルド**:
   - 大きな変更を一度に行わず、小さな変更ごとにビルドして問題を特定

3. **コメントアウト**:
   - 問題のある可能性がある部分を一時的にコメントアウトして、エラーの原因を特定

4. **プリプロセッサの活用**:
   - `#ifdef DEBUG` などの条件付きコンパイルを使用してデバッグコードを管理

5. **段階的なエラー解決**:
   - エラーメッセージを注意深く読み、問題の箇所を特定します。
   - 複数のエラーがある場合は、最初のエラーから順に解決します。

6. **コードの簡略化**:
   - 複雑な実装を一時的に簡略化して、基本的な機能が動作するか確認します。
   - 動作確認後、段階的に元の実装に戻します。

7. **依存関係の確認**:
   - メソッド間の呼び出し関係を確認し、循環参照がないか確認します。
   - クラス間の依存関係を最小限に抑えます。

8. **ビルドフラグの活用**:
   - `-v`（詳細）フラグを使用して、より詳細なビルド情報を取得します。
   ```bash
   & "C:\Program Files\Arduino IDE\resources\app\lib\backend\resources\arduino-cli.exe" compile --fqbn m5stack:esp32:m5stack_atoms3r . -v
   ```

## 特定の機能に関するノウハウ

### IMUセンサー

- AtomS3Rには、BMI270（6軸加速度・ジャイロセンサー）とBMM150（3軸地磁気センサー）の9軸センサーシステムが搭載
- 校正状態は3段階（GOOD、OK、POOR）で表示され、校正されていない場合は「NOT CALIBRATED」と表示

#### AtomS3R IMUセンサー詳細仕様
- **センサー特性**
  - BMI270
    - 加速度計: ±4G範囲、変換係数 8192.0f (INT16_to_G)
    - ジャイロスコープ: ±2000dps範囲、変換係数 16.384f (INT16_to_DPS)
  - BMM150
    - 磁力計: マイクロテスラ(uT)単位で測定

#### 校正機能実装ガイドライン
- **校正ステージ**
  - 3段階の校正プロセスを実装（磁力計、加速度計、ジャイロスコープ）
  - 校正状態表示: GOOD(3)、OK(2)、POOR(1)、NOT CALIBRATED(0)
  - 色分け表示: GOOD(緑)、OK(黄)、POOR(オレンジ)、NOT CALIBRATED(赤)

- **校正手順ガイダンス**
  - 磁力計: 8の字を描くように回転させる
  - 加速度計/ジャイロスコープ: デバイスをあらゆる方向にひっくり返す
  - 校正中はLEDを黄色に点滅させる視覚的フィードバック

- **校正の限界と注意点**
  - M5Unifiedライブラリの基本校正機能はオフセットバイアスのみを推定
  - 完全な校正にはスケールバイアスも測定が必要
  - 高度な校正にはMotionCalなどの外部ツールを推奨

#### IMUデータ表示ガイドライン
- **センサーデータ表示**
  - ジャイロスコープデータ: deg/s単位、緑色で表示
  - 加速度計データ: m/s²単位、黄色で表示
  - 磁力計データ: uT単位、マゼンタ色で表示

- **傾き表示の視覚化**
  - ピッチとロールを円の位置で視覚的に表現
  - 基準円（水平位置）と現在の傾き位置（緑の円）を表示
  - 最大±30度の傾きを円の半径に対応させる

- **データ構造設計**
  - IMUデータはフラットな構造体で管理
  - センサー種別ごとにX/Y/Z軸の値を明確に区別
  - デバッグ出力を整理し、シリアルコンソールで確認可能に

#### 参考実装リソース
- **公式リファレンス**
  - M5Stack AtomS3R工場デモコード: https://github.com/m5stack/M5AtomS3-UserDemo/tree/atoms3r
  - BMI270/BMM150実装例: https://github.com/m5stack/M5AtomS3-UserDemo/blob/atoms3r/platforms/atoms3r/main/hal_atom_s3r/utils/bmi270/src/bmi270.cpp

- **コミュニティリソース**
  - 9軸IMU実装例: https://github.com/bareboat-necessities/bbn-atomS3R/
  - 高度な磁力計校正ツール: https://github.com/bareboat-necessities/bbn-MotionCal

### GPS

- AtomicBase GPS: GPS_TX_PIN = 5, GPS_RX_PIN = -1
- GPSデータの表示には、緯度、経度、高度、衛星数、HDOP、時刻情報が必要

### ディスプレイ

- スプライトを使用したダブルバッファリングを実装
- `_sprite` がnullの場合は直接ディスプレイに描画する分岐処理が必要

### LEDとディスプレイの制御

- **LEDの制御**:
  - AtomS3Rでは、内蔵LEDの制御に`M5.Lcd.fillScreen(color)`を使用します。
  - 色は32ビットRGB形式（0xRRGGBB）で指定します。

- **ディスプレイのダブルバッファリング**:
  - スプライトを使用したダブルバッファリングを実装することで、ちらつきを軽減できます。
  - スプライトが初期化できない場合は、直接ディスプレイに描画する分岐処理を実装してください。

### アニメーション実装のヒント

- **パルスアニメーション**:
  - 明るさを時間とともに変化させる場合は、サインカーブを使用すると自然な変化が得られます。
  - 長時間のアニメーションはバッテリー消費が大きいため、短時間で効果的なアニメーションを心がけます。

- **回転アニメーション**:
  - HSVカラースペースを使用すると、色相の回転アニメーションが実装しやすくなります。
  - 回転方向を指定できるようにすると、より多様な視覚効果が得られます。

### 天体情報表示機能

#### 実装のポイント
- **太陽・月の位置表示**
  - 方位角（Azimuth）と高度（Altitude）を計算し、コンパスローズ上に表示
  - 太陽は黄色、月は白色のマーカーで視覚的に区別
  - 方位角を円周上の位置に変換する計算式: `centerX + radius * sin(azimuth * PI / 180.0)`

- **月齢表示**
  - 月齢は0〜29.53の値で、新月（0）から満月（約14.76）、再び新月へのサイクル
  - `getMoonIllumination()`メソッドで月の輝面比率（%）を計算
  - 月齢に応じたアイコンや数値で表示

- **スプライト処理**
  - ダブルバッファリングのためのスプライト使用が推奨
  - スプライトが初期化されていない場合のフォールバック処理も実装
  - `_sprite->pushSprite(0, 0)`でスプライトをディスプレイに転送

- **LED表示**
  - 天体データ表示中はLEDを紫色（`COLOR_PURPLE`）に設定
  - `setPixelColor()`メソッドを使用（`setPixel()`ではない）
  - 各表示モードで異なる色を使い、視覚的にモードを区別

#### 一般的な問題と解決策
- **方位角計算の問題**
  - 方位角は0〜360度の範囲で、北を0度として時計回りに増加
  - 表示時は数学的な角度（反時計回り、東を0度）に変換が必要
  - 変換式: `screenAngle = 90 - compassAngle`（北を上にする場合）

- **スプライト関連のエラー**
  - `_sprite`がnullの場合に`_sprite->method()`を呼び出すとクラッシュ
  - 必ず`if (_sprite) { ... } else { ... }`の形式でnullチェックを行う
  - スプライトのメモリ解放を忘れないよう注意（`delete _sprite`）

- **LED制御の問題**
  - AtomS3Rでは`setPixel()`ではなく`setPixelColor()`を使用
  - 色定数は`COLOR_RED`などの定義済み定数を使用
  - LEDの更新頻度が高すぎるとちらつきの原因になるため注意

#### パフォーマンス最適化
- 天体位置の計算は計算コストが高いため、必要な時だけ更新
- 表示更新と計算更新の頻度を分けて実装（表示は毎フレーム、計算は数秒ごと）
- 小数点以下の精度は必要最小限に抑える（例：`%.1f`形式で十分）

## パフォーマンスの最適化

1. **メモリ使用量の削減**:
   - 大きな配列や文字列は必要最小限に
   - 動的メモリ割り当ては避け、静的割り当てを優先

2. **描画処理の最適化**:
   - 必要な部分のみを更新
   - スプライトを使用したダブルバッファリングの活用

3. **電力消費の最適化**:
   - 不要なセンサーの電源を切る
   - 処理間隔を適切に設定

## 継続的な改善

- エラーが発生した場合は、このドキュメントに追加して知識を蓄積
- 解決方法を見つけたら、コードにコメントとして残すことも検討

## ビルドエラーの解決方法とGitHub CLIの使用方法に関するノウハウ

### 1. 未実装メソッドによるビルドエラー

**エラー例**:
```
undefined reference to `CompassDisplay::showCelestialData(float, float, float, float, int)'
```

**解決方法**:
- ヘッダファイル(.h)で宣言されているメソッドが実装ファイル(.cpp)で実装されていない場合に発生します。
- 宣言と同じシグネチャ（引数の型と数、戻り値の型）で実装を追加します。
- 実装例:
  ```cpp
  void CompassDisplay::showCelestialData(float sunAzimuth, float sunAltitude, float moonAzimuth, float moonAltitude, int moonPhase) {
    // 実装内容
  }
  ```

### 2. メソッド名の不一致によるエラー

**エラー例**:
```
'setPixel' was not declared in this scope
```

**解決方法**:
- クラス内で定義されているメソッド名と呼び出しているメソッド名が一致しているか確認します。
- 例: `setPixel()`を呼び出している場合、実際のメソッド名が`setPixelColor()`であれば、呼び出し側を修正します。
- AtomS3Rでは、LEDの制御に`setPixelColor()`を使用します（`setPixel()`ではない）。

## GitHub CLIを使用したプルリクエスト作成

GitHub CLIを使用すると、コマンドラインからGitHubのプルリクエストを作成できます。

### 1. GitHub CLIのインストール確認

```powershell
# GitHub CLIがインストールされているか確認
& "C:\Program Files\GitHub CLI\gh.exe" --version
```

### 2. GitHub CLIでの認証

```powershell
# 初回使用時は認証が必要
& "C:\Program Files\GitHub CLI\gh.exe" auth login
```

### 3. プルリクエストの作成

```powershell
# カレントブランチからプルリクエストを作成
& "C:\Program Files\GitHub CLI\gh.exe" pr create --title "タイトル" --body "説明文"
```

### 4. プルリクエストの確認

```powershell
# 作成したプルリクエストの一覧を表示
& "C:\Program Files\GitHub CLI\gh.exe" pr list
```

### 5. プルリクエストのステータス確認

```powershell
# 特定のプルリクエストの詳細を表示
& "C:\Program Files\GitHub CLI\gh.exe" pr view [PR番号]
```

GitHub CLIを使用すると、ブラウザを開かずにプルリクエストの作成や管理ができるため、開発ワークフローが効率化されます。

## M5AtomS3デバイスでの表示調整

### 画面サイズと表示位置

M5AtomS3の小さな画面（128x128ピクセル）に合わせて表示を調整する際のポイント：

- **テキスト位置の最適化**:
  - 行間を詰めて（例：10px → 5px）より多くの情報を表示
  - 重要な情報を画面上部に配置し、スクロールなしで見えるようにする

- **グラフィック要素のサイズ調整**:
  - コンパスローズの半径を小さくする（例：40px → 30px）
  - 中心位置を上部に移動して（例：centerY = 150 → 110）画面内に収める

- **方位表示の工夫**:
  - 方位記号（N, E, S, W）を追加して視認性を向上
  - 北を示す線は赤色で強調し、方向を明確に

- **フォントサイズと色**:
  - 重要な情報は大きめのフォントで表示
  - ステータス情報は色分けして視認性を向上（例：有効=緑、無効=赤）

### アップロード時の注意点

- デバイスがダウンロードモードになっていることを確認してからアップロード
- ダウンロードモードにするには、リセットボタンを押しながらUSB接続するか、接続状態でリセットボタンを長押し
- アップロード失敗時は「No serial data received」などのエラーが表示される
- アップロードコマンド例:
  ```bash
  arduino-cli upload -p COM10 --fqbn m5stack:esp32:m5stack_atoms3r Polaris_Navigator
  ```
