# 要件定義書

## 1. 文書の目的
本書は、AtomS3R（IMU搭載）と AtomicBase GPS を用いて天体撮影向けの極軸合わせサポートデバイスを開発するための要件を定義したものです。デバイスの機能概要、UI仕様、運用条件、および実装上の留意点を明確にし、関係者間の共通認識を形成することを目的とします。

---

## 2. プロジェクト概要

### 2.1 開発の背景
- 天体写真撮影では、正確な極軸合わせが必要となる。  
- 小型で持ち運び可能なデバイスを用い、IMUとGPSから得られる情報を可視化して、極軸合わせを容易にしたい。

### 2.2 目的
- 極軸合わせ時に、望遠鏡（またはカメラ）の向きと天の北極/南極との誤差（方位・高度）を直感的に把握できるデバイスを提供する。  
- 太陽・月の方位や月齢などの天体情報を参考表示し、撮影計画や夜空の状況把握を支援する。

### 2.3 ステークホルダー
- **エンドユーザー:** 天体写真撮影者、アマチュア天文家  
- **開発チーム:** ハードウェアエンジニア、ソフトウェアエンジニア、UIデザイナー  
- **関係者:** デバイスの量産・販売に関わるメーカーなど

---

## 3. システム概要

### 3.1 システム構成
- **AtomS3R:**  
  - IMU（加速度・ジャイロ・磁力計）を搭載し、デバイスの方位や傾斜を計測。  
  - 上面（\-X 方向）を目標軸にしたい場合、ソフトウェア側でオフセットや座標変換を行う。

- **AtomicBase GPS:**  
  - 観測地点の緯度・経度、正確な時刻情報を取得。  
  - 天体位置（天の極、太陽、月）の計算に利用。

- **表示デバイス（内蔵液晶やOLEDなど）**  
  - メインUIを表示し、極軸合わせ誤差や太陽・月の方向などをグラフィカルに表示。
  - LCD（ディスプレイ）とLED（RGB LED）は別のコンポーネントであり、それぞれ異なる制御方法を使用：
    - LCD: M5.Display（M5Unified）を使用して制御。ちらつき問題はこのLCDに関するもの。
    - LED: M5.dis.drawpix()を使用して制御。色は0xRRGGBB形式の16進数で指定。

- **制御用マイコン（AtomS3R内蔵MCU もしくは外付けマイコン）**  
  - センサーデータを取得し、天体計算を行い、UIを制御。

---

## 4. 機能要件

### 4.1 極軸合わせ支援機能

1. **IMUによる方位・高度取得**  
   - デバイスの現在の向きを取得し、天の北極/南極に対する誤差（方位・高度）を算出する。  
   - デフォルトで \-X 方向を前方とし、必要に応じてオフセット（例：180°）やキャリブレーションを行う。

2. **GPSによる天の極位置算出**  
   - 観測地点の緯度に応じて、天の極の高度を算出（北半球: 緯度＝北極高度、南半球: 緯度をもとに南極高度を算出）。  
   - 磁気偏角の補正を行い、真北/真南を正しく求める。

3. **誤差表示**  
   - 方位誤差・高度誤差をグラフィカルに表示（例：大きな誤差時は矢印、小さな誤差時は円の位置表示など）。  
   - 水平線表示でデバイスの傾斜状態を把握可能にする。

### 4.2 天体情報表示機能

1. **太陽の方向表示**  
   - 現在時刻・GPS位置から太陽の方位を計算し、コンパス画面上にオーバーレイ表示する（例：黄色いマーカー）。
   - 太陽の方位角と高度を数値で表示し、ユーザーが正確な位置を把握できるようにする。

2. **月の方向表示**  
   - 同様に月の方位を計算し、白色など別色のマーカーで表示する。
   - 月の方位角と高度を数値で表示し、ユーザーが正確な位置を把握できるようにする。

3. **月齢表示**  
   - 新月を 0 として、約29.53日周期で増減する月齢を計算。数値やアイコンで表示する。
   - 月の輝面比率（%）を計算し、視覚的に理解しやすい形で表示する。

4. **コンパスローズ表示**
   - 天体の位置を直感的に把握できるよう、簡易的なコンパスローズ上に太陽と月の位置を表示する。
   - 北を基準とし、方位角に応じた位置に天体を配置する。
   - 視覚的に区別しやすいよう、太陽は黄色、月は白色で表示する。

### 4.3 その他機能

1. **GPS生値表示モード**  
   - 緯度、経度、衛星受信状況などの生データをユーザーが確認できる画面。

2. **IMU生値表示モード**  
   - 加速度、ジャイロ、磁力計の生データを確認し、キャリブレーション時などのデバッグに活用。

3. **オフセット・キャリブレーション設定**  
   - デバイス取り付け時のズレや磁気ノイズを補正するため、ユーザーがオフセット値を調整可能にする仕組み。

---

## 5. 非機能要件

1. **操作性・ユーザビリティ**  
   - 屋外使用を想定し、画面の視認性やボタン操作のしやすさを考慮。  
   - 誤差表示は色やアニメーションを活用し、直感的に理解できるUIとする。

2. **精度・信頼性**  
   - 磁力計のキャリブレーションや地磁気偏角補正を行い、数度単位の精度を目標とする。  
   - GPSは屋外で安定受信が可能なモジュールを使用し、正確な位置・時刻情報を取得。

3. **耐久性・可搬性**  
   - 屋外での使用を想定し、ある程度の防塵・防滴性能を確保。  
   - 持ち運びしやすい小型・軽量設計。

4. **拡張性**  
   - 将来的なファームウェアアップデートにより、別の天体情報や新機能を追加可能とする。

---

## 6. UI要件

1. **メイン画面**  
   - 極軸合わせのためのコンパス表示。  
   - 誤差が大きい場合は矢印、誤差が小さい場合は円表示など、差分に応じて表示を切り替える。  
   - 水平線を表示し、デバイスの傾斜が把握できる.

2. **ボタン操作**  
   - 単一または複数のボタンで画面モードを切り替え（天の北極/南極表示、GPS生値、IMU生値など）。  
   - オフセットやキャリブレーション設定を行う場合は、設定画面へ遷移.

3. **太陽・月の方向オーバーレイ**  
   - メインコンパス画面に、太陽（黄色）・月（白色）の方向を示すドットやアイコンを表示。  
   - 月齢は画面の一角に数値やアイコンで表示.

---

## 7. 実装方針

1. **ハードウェア**  
   - AtomS3R + AtomicBase GPS を基本構成とする。  
   - 必要に応じて小型ディスプレイ（OLED/TFT）を搭載.

2. **ソフトウェア**  
   - IMUのセンサーフュージョン（加速度・ジャイロ・磁力計）で安定した姿勢情報を取得。  
   - GPSから緯度・経度・時刻を取得し、天体計算ライブラリ（または独自アルゴリズム）で極の位置や太陽・月の方位を算出。  
   - UIはグラフィックライブラリを用いてコンパス表示やオーバーレイを実装.

3. **キャリブレーションとオフセット**  
   - IMUの磁力計キャリブレーション機能を実装。  
   - \-X 軸を前方とするオフセット（例：180°）を適用できるようにする.

---

## 8. リスクと対応策

1. **磁気ノイズ**  
   - 周辺環境の影響で磁力計が狂う可能性がある。  
   - 定期的なキャリブレーション手順や、磁気偏角補正の仕組みを整備.

2. **GPS受信不良**  
   - 屋内や障害物の多い場所で受信が不安定となる。  
   - 屋外使用が前提である旨をマニュアルに明記.

3. **バッテリー駆動時間**  
   - 長時間の観測に対応するため、省電力設計が必要。  
   - 表示の更新頻度やセンサーポーリングを適切に制御.

4. **ユーザー操作ミス**  
   - キャリブレーションやモード切替の誤操作により、誤差が大きくなる可能性。  
   - 操作ガイドの提供やUI設計での誤操作防止策を検討.

---

## 9. 付録

1. **関連資料**  
   - AtomS3R, AtomicBase GPS の技術資料、ピン配置図  
   - 天体計算の参考アルゴリズム（例: NOAA Solar Calculator、月の位相計算式など）

2. **用語集**  
   - IMU (Inertial Measurement Unit), GPS, heading, pitch, roll, yaw, etc.  
   - 極軸合わせ、天の北極、天の南極、磁気偏角、月齢など

3. **問い合わせ先**  
   - 開発チーム連絡先  
   - サポート窓口

---

## 10. AtomS3R IMU仕様と実装ガイドライン

この章は技術的な実装詳細を含むため、knowhow_ja.mdに移動しました。要件定義書では、以下の基本要件のみを記載します：

### 10.1 IMUセンサー要件
- AtomS3Rに搭載されたIMUセンサー（BMI270、BMM150）を使用して、方位、傾き、加速度などを正確に測定できること
- センサーデータを適切に処理し、ユーザーに有用な情報として提供できること

### 10.2 校正機能要件
- ユーザーが簡単に校正を行える機能を提供すること
- 校正状態を視覚的にわかりやすく表示すること
- 校正手順をユーザーに明確に伝える仕組みを持つこと

### 10.3 IMUデータ表示要件
- センサーデータを視覚的に理解しやすい形で表示すること
- 傾き情報を直感的に把握できる表示方法を採用すること
- デバッグ用にも詳細データを確認できる機能を持つこと

### 10.4 UI表示要件
- **コンパス表示**:
  - コンパスは画面中央に配置し、現在の方位を明確に表示すること
  - 方位表示（N/E/S/W）は視認性を確保し、適切なフォントサイズで表示すること

- **高度インジケーター**:
  - 高度インジケーターはコンパスの左側に配置し、コンパスの直径と同じ高さにすること
  - 右側のインジケーターは表示せず、左側のみを表示して画面の簡素化を図ること
  - 目標高度（北極星の高度）と現在の傾き（ピッチ）を視覚的に区別できるようにすること

- **数値表示**:
  - T:（目標値からのずれ）は北（N）と同じ高さに右詰めで表示すること
  - C:（現在値）は南（S）と同じ高さに右詰めで表示すること
  - 数値表示が他の要素と重ならないように適切な位置に配置すること
  - 角度の単位表示は文字化けしないよう、特殊文字（°）の代わりに適切な文字またはスペースを使用すること
  - 正の値には「+」記号を付けて、調整方向を直感的に理解できるようにすること

- **色分け**:
  - 重要な情報は目立つ色（黄色、シアンなど）を使用すること
  - 目標値と現在値は異なる色で表示し、視覚的に区別できるようにすること
  - 背景色と文字色のコントラストを確保し、小型ディスプレイでも視認性を確保すること

- **レイアウト**:
  - 小型ディスプレイ（128x128ピクセル）でも全ての情報が視認できるよう最適化すること
  - 情報の優先順位を考慮し、重要な情報を目立つ位置に配置すること
  - 表示要素間の適切な間隔を確保し、視認性と操作性を向上させること

### 10.5 UI検証と将来的な自動化
- **現在の検証方法**:
  - UI表示の確認は開発チーム内で分担して実施
  - 実機での動作確認を通じて視認性や操作性を評価
  - 複数の環境（明るさ、角度など）での確認を実施

- **将来的な自動検証**:
  - AIによるUI表示の自動検証の可能性を検討
  - スクリーンショットの自動解析による表示位置やレイアウトの検証
  - 色のコントラスト比や視認性の自動評価
  - 表示要素の重なりや位置関係の自動チェック

- **検証基準**:
  - 小型ディスプレイでの視認性（最小フォントサイズ、コントラスト比）
  - 情報の優先順位に基づいた表示位置の適切さ
  - 色覚多様性に配慮した色使い
  - 操作フィードバックの明確さ

### 10.6 起動画面とロゴ表示要件
- **起動画面の要件**
  - 起動時にロゴを表示し、初期化プロセス全体を通してロゴを維持すること
  - 初期化ステータスメッセージは画面下部に表示し、ロゴと干渉しないこと
  - 画面輝度は初期化プロセス全体を通して一貫して維持すること（40%推奨）
  - 初期化完了時のメッセージは中央揃えで表示し、視認性を確保すること

- **ロゴ表示の要件**
  - ロゴは画面上部に配置し、下部18ピクセルをステータスメッセージ用に確保すること
  - ロゴデータは静的配列として保存し、メモリ使用量を最小限に抑えること
  - 初期化メッセージ表示時は画面下部のみをクリアし、ロゴを維持すること

- **LED表示の要件**
  - 初期化中はLEDを青色に設定し、進行中であることを示すこと
  - 初期化完了時はLEDを暗めの緑色（0x007F00）に設定し、完了を示すこと
  - エラー発生時はLEDを赤色に設定し、エラー状態を示すこと
  - LED色が明るすぎると画面の見え方に影響するため、適切な輝度に調整すること

### 10.7 IMU座標系と軸の要件

- **座標系の定義要件**
  - AtomS3Rデバイスの物理的な向きとIMUの座標系の対応関係を明確に定義すること
  - X軸（デバイスの右方向）、Y軸（デバイスの上方向）、Z軸（画面から外向き）の定義を統一すること
  - 極軸合わせ時の標準的な持ち方を考慮した座標系を採用すること

- **軸調整の要件**
  - M5Unifiedライブラリから取得したIMUデータを適切に調整すること
  - 加速度データと地磁気データの軸を一貫して調整すること
  - デバイスの物理的な動きと計算される角度（ピッチ、ロール）が直感的に対応すること

- **角度計算の要件**
  - ピッチ: X-Z平面での傾き（+/-90度）、0度が水平となるよう計算すること
  - ロール: Y-Z平面での傾き（+/-180度）、0度が水平となるよう計算すること
  - 方位角: 北を0度とした水平面内での角度（0-360度）を正確に計算すること
  - デバイスの傾きを考慮したティルト補正を方位角計算に適用すること

- **検証と品質保証の要件**
  - デバイスをピッチ方向に傾けた時に、ピッチの値のみが変化することを確認すること
  - デバイスをロール方向に傾けた時に、ロールの値のみが変化することを確認すること
  - デバイスを水平に保ちながら回転させた時に、方位角が正確に変化することを確認すること
  - 極軸合わせの精度を維持するため、IMUの軸調整が正確であることを検証すること

*注: 詳細な実装ガイドラインについては、knowhow_ja.mdを参照してください。*
